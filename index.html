<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Medication Tracker</title>
    <meta name="description" content="A simple app to track your medication intake and history.">
    <meta name="theme-color" content="#92A3A7">
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22Medication%20Tracker%22%2C%22short_name%22%3A%22MedTracker%22%2C%22description%22%3A%22A%20simple%20app%20to%20track%20your%20medication%20intake%20and%20history.%22%2C%22start_url%22%3A%22./%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23FFFFFF%22%2C%22theme_color%22%3A%22%2392A3A7%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%3Bcharset%3DUTF-8%2C%253Csvg%2520xmlns%3D%27http%3A//www.w3.org/2000/svg%27%2520width%3D%27192%27%2520height%3D%27192%27%2520viewBox%3D%270%25200%2520192%2520192%27%253E%253Crect%2520width%3D%27192%27%2520height%3D%27192%27%2520fill%3D%27%2523FFFFFF%27/%253E%253Cpath%2520d%3D%27M86%252032h20v54h54v20h-54v54h-20v-54h-54v-20h54z%27%2520fill%3D%27%252392A3A7%27/%253E%253C/svg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image/svg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%2C%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%3Bcharset%3DUTF-8%2C%253Csvg%2520xmlns%3D%27http%3A//www.w3.org/2000/svg%27%2520width%3D%27512%27%2520height%3D%27512%27%2520viewBox%3D%270%25200%2520512%2520512%27%253E%253Crect%2520width%3D%27512%27%2520height%3D%27512%27%2520fill%3D%27%2523FFFFFF%27/%253E%253Cpath%2520d%3D%27M224%252096h64v128h128v64h-128v128h-64v-128h-128v-64h128z%27%2520fill%3D%27%252392A3A7%27/%253E%253C/svg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image/svg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
    <style>
        :root {
            --primary-bg: white;
            --text-color-main: #2F2F2F;
            --text-color-header: #4A4A4A;
            --text-color-subheader: #8A8A8A;
            --text-color-light: #6A6A6A;
            --text-color-medication-name: white;
            --text-color-medication-status: rgba(255, 255, 255, 0.85);
            --border-color-light: #EEEEEE;
            --border-color-input: #E0E0E0;
            --accent-color: #92A3A7;
            --action-color-undo: #D32F2F; 
            --action-color-redo: #2196F3; 
            --action-color-delete: #D32F2F; 
            --disabled-color: #CCCCCC;
            --modal-backdrop-color: rgba(0, 0, 0, 0.4);
            --toast-bg: rgba(74, 74, 74, 0.9);
            
            --font-family-system: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            --base-font-weight: 300; 
            --action-font-weight: 500; 


            --transition-duration: 0.3s;
            --transition-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-transform: transform var(--transition-duration) var(--transition-timing-function);

            --safe-gradient-start: #2E7D32;
            --safe-gradient-end: #4CAF50;
            --recent-gradient-start: #E65100;
            --recent-gradient-end: #FF9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-system);
            background: var(--primary-bg);
            color: var(--text-color-main);
            line-height: 1.6;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden; 
            font-weight: var(--base-font-weight);
        }

        .app-container {
            width: 100%;
            height: 100vh;
            overflow: hidden; 
            position: relative;
        }

        .main-screen, .records-screen {
            width: 100%;
            height: 100%; 
            background: var(--primary-bg);
            position: absolute;
            top: 0;
            left: 0;
            display: flex; 
            flex-direction: column;
            transition: transform var(--transition-duration) var(--transition-timing-function);
        }

        .main-screen {
            z-index: 5; 
            transform: translateX(0);
        }
        
        .main-screen.viewing-records {
            transform: translateX(-100%);
        }

        .records-screen {
            transform: translateX(100%); 
            z-index: 10; 
        }

        .records-screen.active { 
            transform: translateX(0);
        }

        .container, .records-container { 
            width: 100%;
            padding: 0; 
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            padding: 20px 20px 32px; 
        }

        .header h1 {
            font-size: 28px;
            font-weight: var(--base-font-weight);
            color: var(--text-color-header);
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .medications-list {
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: 20px; 
        }

        .medication-item {
            position: relative;
            border-bottom: 1px solid var(--border-color-light);
            cursor: pointer; 
            overflow: hidden; 
        }

        .medication-item:last-child {
            border-bottom: none;
        }
        
        .medication-content-wrapper { 
            position: relative;
            z-index: 2; 
            background: inherit; 
        }

        .medication-content { 
            padding: 24px 20px;
            text-align: center;
        }

        .medication-name {
            font-size: 24px;
            font-weight: var(--base-font-weight);
            margin-bottom: 8px;
            color: var(--text-color-medication-name);
            letter-spacing: -0.4px;
            text-transform: uppercase;
        }

        .medication-status {
            font-size: 12px;
            color: var(--text-color-medication-status);
            font-weight: var(--base-font-weight);
        }
        .medication-last-consumed {
            font-size: 10px; 
            color: rgba(255, 255, 255, 0.75); 
            font-weight: var(--base-font-weight);
            margin-top: 6px;
        }
        
        .footer-actions {
            display: flex; 
            align-items: stretch; 
            border-top: 1px solid var(--border-color-light);
        }

        .more-options-wrapper {
            position: relative; 
        }

        .action-button { 
            background: none;
            color: var(--accent-color);
            border: none;
            padding: 18px; 
            font-size: 16px;
            font-weight: var(--base-font-weight);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease, background-color 0.2s ease;
            letter-spacing: -0.2px;
        }
        .action-button:active {
            background: #F8F8F8; 
        }

        .more-options-trigger {
            border-right: 1px solid var(--border-color-light); 
            padding: 18px 20px; 
        }
        .more-options-trigger svg {
            display: block; 
            fill: currentColor; 
        }

        .add-medication-footer-btn {
            flex-grow: 1; 
            gap: 8px;
        }
        
        .options-menu {
            position: absolute;
            bottom: calc(100% + 5px); 
            left: 0;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color-light);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 20; 
            display: none; 
            width: max-content; 
            min-width: 180px; 
        }
        .options-menu.active {
            display: block;
        }
        .menu-button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            border-bottom: 1px solid var(--border-color-light);
            color: var(--text-color-header);
            font-size: 15px;
            cursor: pointer;
        }
        .menu-button:last-child {
            border-bottom: none;
        }
        .menu-button:hover {
            background-color: #f9f9f9;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-backdrop-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-duration) ease, visibility var(--transition-duration) ease;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--primary-bg);
            margin: 20px;
            max-width: 400px;
            width: calc(100% - 40px);
            transform: scale(0.95);
            transition: transform var(--transition-duration) ease;
            border-radius: 8px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border-color-light);
            display: flex; 
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 { 
            font-size: 20px;
            color: var(--text-color-header);
            font-weight: var(--base-font-weight);
            letter-spacing: -0.3px;
            flex-grow: 1; 
            text-align: center; 
        }
        .modal-header .delete-med-icon-btn,
        .modal-header .record-entry-delete-btn { 
            flex-shrink: 0; 
        }
        #actionChoiceModal .modal-header h2, 
        .modal-header h2:only-child { 
            margin-left: auto;
            margin-right: auto;
        }


        .modal-body {
            padding: 24px;
        }
        
        .modal-buttons {
            display: flex;
            border-top: 1px solid var(--border-color-light);
        }

        .modal-btn { 
            flex: 1;
            padding: 18px; 
            border: none;
            background: none;
            font-size: 16px;
            font-weight: var(--base-font-weight); 
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            letter-spacing: -0.2px;
        }

        .modal-cancel-btn { 
            border-right: 1px solid var(--border-color-light);
            color: var(--text-color-subheader);
        }
        .modal-cancel-btn:hover {
            background: #f0f0f0;
        }

        .modal-confirm-btn { 
            color: var(--accent-color);
            font-weight: var(--action-font-weight); 
        }
        .modal-confirm-btn:hover {
            background: #e8f0f2;
        }
        .modal-confirm-btn.delete-confirm-style { 
            color: var(--action-color-delete);
            font-weight: var(--action-font-weight);
        }

        /* Ensure Action Choice buttons have consistent (base) font weight */
        #actionChoiceViewRecordsBtn, 
        #actionChoiceLogBtn {
            font-weight: var(--base-font-weight);
        }
        /* Retain accent color for Log Dose button in Action Choice modal for primary action cue */
         #actionChoiceLogBtn {
            color: var(--accent-color);
         }


        #modalTitle { 
        }

        .delete-med-icon-btn {
            background: none;
            border: none;
            color: var(--action-color-delete);
            cursor: pointer;
            padding: 4px; 
            display: none; 
        }
        .delete-med-icon-btn svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: var(--base-font-weight);
            color: var(--text-color-light);
            font-size: 14px;
            letter-spacing: -0.1px;
        }

        .form-group input {
            width: 100%;
            padding: 16px 0;
            border: none;
            border-bottom: 1px solid var(--border-color-input);
            font-size: 16px;
            background: none;
            transition: border-color 0.2s ease;
            font-weight: var(--base-font-weight);
            color: var(--text-color-header);
        }
        .form-group input[type="date"], .form-group input[type="time"] {
            padding: 12px 10px; 
            border: 1px solid var(--border-color-input);
            border-radius: 4px;
        }


        #deleteConfirmationText { 
            padding: 20px;
            text-align: center;
            color: var(--text-color-light);
            font-size: 15px;
            display: none; 
        }
        #recordEntryDeleteConfirmationText { 
             padding: 10px 24px 20px;
             text-align: center;
             color: var(--text-color-light);
             font-size: 15px;
             display: none;
        }


        #actionChoiceModal .modal-body { 
            display: none; 
        }
        #actionChoiceModal .modal-header { 
            justify-content: center;
            border-bottom: none; 
            padding-bottom: 20px; 
        }
        #actionChoiceModal .modal-buttons {
            border-top: 1px solid var(--border-color-light); 
        }


        .records-header {
            padding: 20px; 
            text-align: center;
            border-bottom: 1px solid var(--border-color-light);
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }
        
        .records-title {
            font-size: 22px;
            font-weight: var(--base-font-weight);
            color: var(--text-color-header);
            letter-spacing: -0.3px;
            text-transform: uppercase;
            flex-grow: 1; 
            text-align: center; 
            margin: 0 5px; 
        }

        .header-action-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 10px; 
            line-height: 0; 
            flex-shrink: 0; 
        }
        .header-action-btn svg {
            width: 24px;
            height: 24px;
            display: block;
            stroke: currentColor; 
        }


        .records-content {
            flex: 1;
            padding: 0 20px;
            overflow-y: auto;
        }

        .record-item {
            padding: 12px 0px; 
            font-size: 19px;
            color: #000000;
            font-weight: var(--base-font-weight);
            display: flex;
            align-items: center;
            justify-content: space-between; 
            border-bottom: 1px solid var(--border-color-light);
        }
        .record-item span { 
            flex-grow: 1;
        }
        .record-item:last-child {
            border-bottom: none;
        }
        
        .record-entry-action-btn {
            background: none;
            border: none;
            color: var(--text-color-light);
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
        }
        .record-entry-action-btn svg {
            width: 18px;
            height: 18px;
            display: block;
            fill: currentColor;
        }

        .empty-records {
            text-align: center;
            color: #9A9A9A; 
            font-size: 16px;
            margin-top: 80px;
            font-weight: var(--base-font-weight);
            padding: 0 20px; 
        }

        .records-footer-action {
            border-top: 1px solid var(--border-color-light);
        }
        #addManualRecordBtn { 
            width: 100%;
            padding: 18px 0;
            font-size: 16px;
            font-weight: var(--base-font-weight);
            color: var(--accent-color);
            background: none;
            border: none; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            letter-spacing: -0.2px;
        }
        #addManualRecordBtn:active {
            background: #F8F8F8;
        }

        .toast {
            position: fixed;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%) translateY(100px); 
            background: var(--toast-bg);
            color: white;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 300; 
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-duration) ease, visibility var(--transition-duration) ease, transform var(--transition-duration) var(--transition-timing-function);
            backdrop-filter: blur(10px);
            letter-spacing: -0.1px;
            border-radius: 6px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toast.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0); 
        }
        
        @media (max-width: 480px) {
            .header { padding: 16px 16px 24px; }
            .records-header { padding: 16px; } 
            .records-content { padding: 0 16px; }
            .medications-list { padding-bottom: 16px; }
            
            .header h1 { font-size: 24px; }
            .medication-content { padding: 20px 16px; } 
            .modal-content { margin: 16px; width: calc(100% - 32px); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-screen" id="mainScreen">
            <div class="container">
                <div class="header">
                    <h1>MedTracker</h1>
                </div>
                <div class="medications-list" id="medicationsList">
                </div>
                <div class="footer-actions">
                    <div class="more-options-wrapper">
                        <button class="action-button more-options-trigger" id="moreOptionsTriggerBtn" aria-label="More options">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="5.5" r="1.5" fill="currentColor"></circle>
                                <circle cx="12" cy="12" r="1.5" fill="currentColor"></circle>
                                <circle cx="12" cy="18.5" r="1.5" fill="currentColor"></circle>
                            </svg>
                        </button>
                        <div class="options-menu" id="optionsMenu">
                            <button class="menu-button" id="exportDataMenuBtn">Export Data</button>
                            <button class="menu-button" id="importDataMenuBtn">Import Data</button>
                        </div>
                    </div>
                    <button class="action-button add-medication-footer-btn" id="addMedicationFooterBtn">
                        + Add Medication
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </div>
        </div>

        <div class="records-screen" id="recordsScreen">
            <div class="records-container">
                <div class="records-header" id="recordsHeader">
                    <button class="header-action-btn" id="backToMainBtn" aria-label="Back to Main Screen">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <h2 class="records-title" id="recordsTitle">Records</h2>
                    <button class="header-action-btn" id="editCurrentMedicationBtn" aria-label="Edit Medication">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                            <path d="M15 5l4 4"></path>
                        </svg>
                    </button>
                </div>
                <div class="records-content" id="recordsContent">
                </div>
                <div class="records-footer-action">
                     <button id="addManualRecordBtn" class="action-button">+ Add Manual Record</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="medicationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Medication</h2>
                <button class="delete-med-icon-btn" id="deleteMedIconBtn" aria-label="Delete Medication">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            </div>
            <form id="medicationForm">
                <div class="modal-body" id="medicationFormBody">
                    <div class="form-group">
                        <label for="modalMedicationName">Medication Name</label>
                        <input type="text" id="modalMedicationName" required>
                    </div>
                    <div class="form-group">
                        <label for="modalTimeBetween">Hours Between Doses</label>
                        <input type="number" id="modalTimeBetween" min="1" max="48" value="4" required>
                    </div>
                    <div class="form-group">
                        <label for="modalMaxDoses">Max Doses Per Day (Optional)</label>
                        <input type="number" id="modalMaxDoses" min="1" max="24">
                    </div>
                </div>
                <div id="deleteConfirmationText">Are you sure you want to delete this medication? This action cannot be undone.</div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-cancel-btn" id="modalCancelBtn">Cancel</button>
                    <button type="submit" class="modal-btn modal-confirm-btn" id="modalActionBtn">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="actionChoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="actionChoiceModalTitle">Choose Action for [Medication Name]</h2>
            </div>
            <div class="modal-buttons"> 
                <button type="button" class="modal-btn modal-cancel-btn" id="actionChoiceViewRecordsBtn">View Records</button>
                <button type="button" class="modal-btn modal-confirm-btn" id="actionChoiceLogBtn">Log Dose</button>
            </div>
        </div>
    </div>

    <div class="modal" id="recordEntryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recordEntryModalTitle">Add Manual Record</h2>
                 <button class="delete-med-icon-btn" id="deleteRecordEntryBtn" aria-label="Delete Record Entry" style="display:none;"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            </div>
            <form id="recordEntryForm">
                <div class="modal-body" id="recordEntryFormBody">
                    <div class="form-group">
                        <label for="recordEntryDate">Date</label>
                        <input type="date" id="recordEntryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="recordEntryTime">Time</label>
                        <input type="time" id="recordEntryTime" required>
                    </div>
                </div>
                <div id="recordEntryDeleteConfirmationText">Are you sure you want to delete this record entry? This action cannot be undone.</div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-cancel-btn" id="recordEntryCancelBtn">Cancel</button>
                    <button type="submit" class="modal-btn modal-confirm-btn" id="recordEntryActionBtn">Add Record</button>
                </div>
            </form>
        </div>
    </div>


    <div class="toast" id="toast"></div>

    <script>
        class MedicationTracker {
            constructor() {
                this.dom = {
                    mainScreen: document.getElementById('mainScreen'),
                    recordsScreen: document.getElementById('recordsScreen'),
                    medicationsList: document.getElementById('medicationsList'),
                    
                    medicationModal: document.getElementById('medicationModal'),
                    modalTitle: document.getElementById('modalTitle'),
                    medicationForm: document.getElementById('medicationForm'),
                    medicationFormBody: document.getElementById('medicationFormBody'),
                    deleteConfirmationText: document.getElementById('deleteConfirmationText'),
                    modalMedicationName: document.getElementById('modalMedicationName'),
                    modalTimeBetween: document.getElementById('modalTimeBetween'),
                    modalMaxDoses: document.getElementById('modalMaxDoses'),
                    modalCancelBtn: document.getElementById('modalCancelBtn'),
                    modalActionBtn: document.getElementById('modalActionBtn'),
                    deleteMedIconBtn: document.getElementById('deleteMedIconBtn'),

                    recordsHeader: document.getElementById('recordsHeader'),
                    editCurrentMedicationBtn: document.getElementById('editCurrentMedicationBtn'),
                    backToMainBtn: document.getElementById('backToMainBtn'), 
                    recordsTitle: document.getElementById('recordsTitle'),
                    recordsContent: document.getElementById('recordsContent'),
                    addManualRecordBtn: document.getElementById('addManualRecordBtn'),
                    toast: document.getElementById('toast'),
                    addMedicationFooterBtn: document.getElementById('addMedicationFooterBtn'),
                    moreOptionsTriggerBtn: document.getElementById('moreOptionsTriggerBtn'),
                    optionsMenu: document.getElementById('optionsMenu'),
                    exportDataMenuBtn: document.getElementById('exportDataMenuBtn'),
                    importDataMenuBtn: document.getElementById('importDataMenuBtn'),
                    importFileInput: document.getElementById('importFile'),

                    actionChoiceModal: document.getElementById('actionChoiceModal'),
                    actionChoiceModalTitle: document.getElementById('actionChoiceModalTitle'),
                    actionChoiceLogBtn: document.getElementById('actionChoiceLogBtn'),
                    actionChoiceViewRecordsBtn: document.getElementById('actionChoiceViewRecordsBtn'),

                    recordEntryModal: document.getElementById('recordEntryModal'),
                    recordEntryModalTitle: document.getElementById('recordEntryModalTitle'),
                    recordEntryForm: document.getElementById('recordEntryForm'),
                    recordEntryFormBody: document.getElementById('recordEntryFormBody'),
                    recordEntryDate: document.getElementById('recordEntryDate'),
                    recordEntryTime: document.getElementById('recordEntryTime'),
                    recordEntryDeleteConfirmationText: document.getElementById('recordEntryDeleteConfirmationText'),
                    recordEntryCancelBtn: document.getElementById('recordEntryCancelBtn'),
                    recordEntryActionBtn: document.getElementById('recordEntryActionBtn'),
                    deleteRecordEntryBtn: document.getElementById('deleteRecordEntryBtn')
                };

                this.medications = JSON.parse(localStorage.getItem('medications') || '[]');
                this.currentRecordsMedication = null;
                this.editingMedicationId = null; 
                this.confirmingDeleteMedication = false; 
                this.actionChoiceMedicationId = null; 
                
                this.editingRecordTimestamp = null; 
                this.confirmingDeleteRecordEntry = false;
                this.activeMedicationForRecordEntry = null; 


                this.isScreenTransitioning = false;
                this.toastTimeout = null;
                this.currentHistoryState = null; 

                this.init();
            }

            init() {
                this.renderMedications();
                this.startTimeUpdater();
                this.setupEventListeners();
                window.addEventListener('popstate', (event) => this.handlePopState(event));
                if (!history.state || history.state.screen !== 'main') {
                    history.replaceState({ screen: 'main', medId: null }, "Main Screen", "#main");
                }
                this.currentHistoryState = 'main';
            }
            
            handlePopState(event) {
                const state = event.state;
                const targetScreen = state ? state.screen : null;
                console.log("PWA DEBUG: Popstate event. Target screen:", targetScreen, "Target Med ID:", state ? state.medId : "N/A");

                if (targetScreen === 'main' && this.recordsScreenActive()) {
                    this.hideRecords(true); 
                } else if (targetScreen === 'records' && !this.recordsScreenActive() && state.medId) {
                    this.showRecords(state.medId, true); 
                } else if (!targetScreen && this.recordsScreenActive()) { 
                    this.hideRecords(true);
                }
                this.currentHistoryState = targetScreen || 'main';
            }

            recordsScreenActive() {
                return this.dom.recordsScreen.classList.contains('active');
            }


            startTimeUpdater() {
                setInterval(() => {
                    if (!this.isScreenTransitioning) {
                        this.renderMedications();
                    }
                }, 1000);
            }

            setupEventListeners() {
                this.dom.medicationForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleModalFormSubmit();
                });
                this.dom.medicationModal.addEventListener('click', (e) => {
                    if (e.target === this.dom.medicationModal) this.hideMedicationModal();
                });
                this.dom.modalCancelBtn.addEventListener('click', () => {
                    if (this.confirmingDeleteMedication) {
                        const medToEdit = this.medications.find(m => m.id === this.editingMedicationId);
                        if (medToEdit) this.prepareEditModal(medToEdit);
                        else this.hideMedicationModal(); 
                    } else {
                        this.hideMedicationModal();
                    }
                });

                this.dom.addMedicationFooterBtn.addEventListener('click', () => this.prepareAddModal());
                this.dom.moreOptionsTriggerBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    this.toggleOptionsMenu();
                });
                this.dom.exportDataMenuBtn.addEventListener('click', () => {
                    this.exportData();
                    this.toggleOptionsMenu(false); 
                });
                this.dom.importDataMenuBtn.addEventListener('click', () => {
                    this.dom.importFileInput.click(); 
                });
                
                this.dom.importFileInput.addEventListener('change', (event) => {
                    this.importData(event);
                    this.toggleOptionsMenu(false); 
                });

                document.addEventListener('click', (event) => {
                    if (this.dom.optionsMenu.classList.contains('active') && 
                        !this.dom.optionsMenu.contains(event.target) && 
                        !this.dom.moreOptionsTriggerBtn.contains(event.target) &&
                        event.target !== this.dom.moreOptionsTriggerBtn 
                        ) {
                        this.toggleOptionsMenu(false);
                    }
                });

                this.dom.editCurrentMedicationBtn.addEventListener('click', () => {
                    if (this.currentRecordsMedication) {
                        this.prepareEditModal(this.currentRecordsMedication);
                    }
                });
                this.dom.deleteMedIconBtn.addEventListener('click', () => {
                    this.prepareDeleteMedicationConfirmation();
                });

                this.dom.backToMainBtn.addEventListener('click', () => {
                    if (history.state?.screen === 'records') {
                        history.back();
                    } else { // Fallback if history state is unexpected
                        this.hideRecords(false); 
                    }
                });


                this.dom.actionChoiceModal.addEventListener('click', (e) => {
                    if (e.target === this.dom.actionChoiceModal) this.hideActionChoiceModal();
                });
                this.dom.actionChoiceLogBtn.addEventListener('click', () => {
                    if (this.actionChoiceMedicationId) this.consumeMedication(this.actionChoiceMedicationId);
                    this.hideActionChoiceModal();
                });
                this.dom.actionChoiceViewRecordsBtn.addEventListener('click', () => {
                    if (this.actionChoiceMedicationId) this.showRecords(this.actionChoiceMedicationId);
                    this.hideActionChoiceModal();
                });

                this.dom.addManualRecordBtn.addEventListener('click', () => {
                    this.prepareRecordEntryModal(); 
                });
                this.dom.recordEntryModal.addEventListener('click', (e) => {
                    if (e.target === this.dom.recordEntryModal) this.hideRecordEntryModal();
                });
                this.dom.recordEntryForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRecordEntryFormSubmit();
                });
                this.dom.recordEntryCancelBtn.addEventListener('click', () => {
                     if (this.confirmingDeleteRecordEntry) {
                        this.prepareRecordEntryModal(this.editingRecordTimestamp); 
                    } else {
                        this.hideRecordEntryModal();
                    }
                });
                this.dom.deleteRecordEntryBtn.addEventListener('click', () => {
                    this.prepareDeleteRecordEntryConfirmation();
                });
            }
            
            toggleOptionsMenu(forceState) {
                if (typeof forceState === 'boolean') {
                    this.dom.optionsMenu.classList.toggle('active', forceState);
                } else {
                    this.dom.optionsMenu.classList.toggle('active');
                }
            }

            prepareAddModal() {
                this.editingMedicationId = null;
                this.confirmingDeleteMedication = false;
                this.dom.medicationForm.reset();
                this.dom.modalTitle.textContent = 'Add Medication';
                this.dom.modalActionBtn.textContent = 'Add';
                this.dom.modalActionBtn.className = 'modal-btn modal-confirm-btn'; 
                this.dom.deleteMedIconBtn.style.display = 'none';
                this.dom.medicationFormBody.style.display = 'block';
                this.dom.deleteConfirmationText.style.display = 'none';
                this.dom.modalCancelBtn.textContent = 'Cancel';
                
                this.dom.medicationModal.classList.add('active');
                setTimeout(() => this.dom.modalMedicationName.focus(), 50); 
            }

            prepareEditModal(medication) {
                if (!medication) return;
                this.editingMedicationId = medication.id;
                this.confirmingDeleteMedication = false;
                this.dom.modalTitle.textContent = 'Edit Medication'; 
                this.dom.modalMedicationName.value = medication.name;
                this.dom.modalTimeBetween.value = medication.timeBetweenHours;
                this.dom.modalMaxDoses.value = medication.maxDosesPerDay || '';
                
                this.dom.modalActionBtn.textContent = 'Save Changes';
                this.dom.modalActionBtn.className = 'modal-btn modal-confirm-btn'; 
                this.dom.deleteMedIconBtn.style.display = 'block';
                this.dom.medicationFormBody.style.display = 'block';
                this.dom.deleteConfirmationText.style.display = 'none';
                this.dom.modalCancelBtn.textContent = 'Cancel';
                this.dom.medicationModal.classList.add('active');
            }

            prepareDeleteMedicationConfirmation() {
                if (!this.editingMedicationId) return;
                const medication = this.medications.find(m => m.id === this.editingMedicationId);
                if (!medication) return;

                this.confirmingDeleteMedication = true;
                this.dom.modalTitle.textContent = `Delete ${medication.name}?`; 
                this.dom.medicationFormBody.style.display = 'none';
                this.dom.deleteConfirmationText.style.display = 'block';
                this.dom.deleteMedIconBtn.style.display = 'none'; 
                this.dom.modalActionBtn.textContent = 'Confirm Delete';
                this.dom.modalActionBtn.className = 'modal-btn modal-confirm-btn delete-confirm-style'; 
                this.dom.modalCancelBtn.textContent = 'Cancel'; 
            }


            hideMedicationModal() {
                this.dom.medicationModal.classList.remove('active');
                this.editingMedicationId = null;
                this.confirmingDeleteMedication = false;
                this.dom.modalTitle.textContent = 'Add Medication';
                this.dom.modalActionBtn.textContent = 'Add';
                this.dom.modalActionBtn.className = 'modal-btn modal-confirm-btn';
                this.dom.deleteMedIconBtn.style.display = 'none';
                this.dom.medicationFormBody.style.display = 'block';
                this.dom.deleteConfirmationText.style.display = 'none';
                this.dom.modalCancelBtn.textContent = 'Cancel';
                this.dom.medicationForm.reset();
            }

            handleModalFormSubmit() {
                if (this.confirmingDeleteMedication) {
                    this.deleteMedication();
                    return;
                }

                const name = this.dom.modalMedicationName.value.trim();
                const timeBetween = parseInt(this.dom.modalTimeBetween.value);
                const maxDoses = parseInt(this.dom.modalMaxDoses.value) || 0;

                if (!name || !timeBetween) {
                    this.showToast('Please fill in required fields.');
                    return;
                }

                if (this.editingMedicationId) { 
                    const medIndex = this.medications.findIndex(m => m.id === this.editingMedicationId);
                    if (medIndex > -1) {
                        this.medications[medIndex] = {
                            ...this.medications[medIndex],
                            name,
                            timeBetweenHours: timeBetween,
                            maxDosesPerDay: maxDoses
                        };
                        this.saveAndRender();
                        this.showToast(`${name} updated.`);
                        if (this.currentRecordsMedication && this.currentRecordsMedication.id === this.editingMedicationId) {
                            this.currentRecordsMedication = this.medications[medIndex]; 
                            this.dom.recordsTitle.textContent = name; 
                            this.updateRecordsDisplay(); 
                        }
                    }
                } else { 
                    const newMedication = { id: Date.now().toString(), name, timeBetweenHours: timeBetween, maxDosesPerDay: maxDoses, records: [] };
                    this.medications.push(newMedication);
                    this.saveAndRender();
                    this.showToast(`${name} added successfully.`);
                }
                this.hideMedicationModal();
            }
            
            deleteMedication() {
                if (!this.editingMedicationId) return;
                const currentMedId = this.editingMedicationId; // Store before it's nulled
                const medicationName = this.medications.find(m => m.id === currentMedId)?.name || 'Medication';
                
                this.medications = this.medications.filter(m => m.id !== currentMedId);
                this.saveMedications(); 
                this.hideMedicationModal(); // This will nullify this.editingMedicationId

                if (this.currentRecordsMedication && this.currentRecordsMedication.id === currentMedId) {
                    if (history.state?.screen === 'records' && history.state?.medId === currentMedId) {
                         history.back(); 
                    } else {
                        this.hideRecords(false); 
                    }
                }
                this.renderMedications(); 
                this.showToast(`${medicationName} deleted.`);
                // this.editingMedicationId is already nulled by hideMedicationModal
                this.confirmingDeleteMedication = false;
            }

            showActionChoiceModal(medication) {
                if (!medication) return;
                this.actionChoiceMedicationId = medication.id;
                this.dom.actionChoiceModalTitle.textContent = `Choose Action for ${medication.name}`; 
                this.dom.actionChoiceModal.classList.add('active');
            }
    
            hideActionChoiceModal() {
                this.dom.actionChoiceModal.classList.remove('active');
                this.actionChoiceMedicationId = null;
            }
            
            prepareRecordEntryModal(timestampToEdit = null) {
                if (!this.currentRecordsMedication) { 
                    this.showToast("Error: No medication selected to add/edit record for.");
                    return;
                }
                this.activeMedicationForRecordEntry = this.currentRecordsMedication; 
                this.editingRecordTimestamp = timestampToEdit;
                this.confirmingDeleteRecordEntry = false;
                this.dom.recordEntryFormBody.style.display = 'block';
                this.dom.recordEntryDeleteConfirmationText.style.display = 'none';
                this.dom.recordEntryActionBtn.className = 'modal-btn modal-confirm-btn';
                this.dom.recordEntryCancelBtn.textContent = 'Cancel';


                if (timestampToEdit) {
                    this.dom.recordEntryModalTitle.textContent = 'Edit Record Entry';
                    this.dom.recordEntryActionBtn.textContent = 'Save Changes';
                    this.dom.deleteRecordEntryBtn.style.display = 'block';

                    const date = new Date(timestampToEdit);
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    this.dom.recordEntryDate.value = `${year}-${month}-${day}`;
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    this.dom.recordEntryTime.value = `${hours}:${minutes}`;
                } else {
                    this.dom.recordEntryModalTitle.textContent = 'Add Manual Record';
                    this.dom.recordEntryActionBtn.textContent = 'Add Record';
                    this.dom.deleteRecordEntryBtn.style.display = 'none';
                    this.dom.recordEntryForm.reset(); 
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    this.dom.recordEntryDate.value = `${year}-${month}-${day}`;
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    this.dom.recordEntryTime.value = `${hours}:${minutes}`;
                }
                this.dom.recordEntryModal.classList.add('active');
            }

            hideRecordEntryModal() {
                this.dom.recordEntryModal.classList.remove('active');
                this.editingRecordTimestamp = null;
                this.confirmingDeleteRecordEntry = false;
                this.activeMedicationForRecordEntry = null; 
            }

            handleRecordEntryFormSubmit() {
                const targetMedication = this.activeMedicationForRecordEntry; 

                if (this.confirmingDeleteRecordEntry) {
                    this.deleteRecordEntry(); 
                    return;
                }

                if (!targetMedication) {
                    this.showToast('Error: No medication context for record entry.');
                    this.hideRecordEntryModal();
                    return;
                }

                const dateStr = this.dom.recordEntryDate.value;
                const timeStr = this.dom.recordEntryTime.value;

                if (!dateStr || !timeStr) {
                    this.showToast('Please select both date and time.');
                    return;
                }
                
                const localDateTime = new Date(`${dateStr}T${timeStr}`);
                if (isNaN(localDateTime.getTime())) {
                    this.showToast('Invalid date or time format.');
                    return;
                }
                const newTimestamp = localDateTime.getTime();
                
                if (this.editingRecordTimestamp) { 
                    const recordIndex = targetMedication.records.indexOf(this.editingRecordTimestamp);
                    if (recordIndex > -1) {
                        targetMedication.records.splice(recordIndex, 1, newTimestamp);
                        this.showToast('Record entry updated.');
                    } else {
                         this.showToast('Original record not found for update.');
                    }
                } else { 
                    targetMedication.records.push(newTimestamp);
                    this.showToast('Manual record added.');
                }
                
                targetMedication.records.sort((a, b) => a - b); 
                this.saveAndRender(); 
                this.updateRecordsDisplay(); 
                this.hideRecordEntryModal();
            }

            prepareDeleteRecordEntryConfirmation() {
                if (!this.editingRecordTimestamp || !this.activeMedicationForRecordEntry) return;
                this.confirmingDeleteRecordEntry = true;
                this.dom.recordEntryModalTitle.textContent = 'Delete This Entry?';
                this.dom.recordEntryFormBody.style.display = 'none';
                this.dom.recordEntryDeleteConfirmationText.style.display = 'block';
                this.dom.deleteRecordEntryBtn.style.display = 'none';
                this.dom.recordEntryActionBtn.textContent = 'Confirm Delete';
                this.dom.recordEntryActionBtn.className = 'modal-btn modal-confirm-btn delete-confirm-style';
                this.dom.recordEntryCancelBtn.textContent = 'Cancel';
            }

            deleteRecordEntry() {
                const targetMedication = this.activeMedicationForRecordEntry;
                if (!targetMedication || this.editingRecordTimestamp === null) return;
                
                const recordIndex = targetMedication.records.indexOf(this.editingRecordTimestamp);
                if (recordIndex > -1) {
                    targetMedication.records.splice(recordIndex, 1);
                    this.saveAndRender();
                    this.updateRecordsDisplay();
                    this.showToast('Record entry deleted.');
                } else {
                    this.showToast('Could not find record to delete.');
                }
                this.hideRecordEntryModal();
            }


            exportData() {
                if (this.medications.length === 0) {
                    this.showToast('No data to export.');
                    return;
                }
                const jsonData = JSON.stringify(this.medications, null, 2); 
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `medication_tracker_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showToast('Data exported successfully.');
            }

            importData(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedMedications = JSON.parse(e.target.result);
                        if (!Array.isArray(importedMedications)) {
                            throw new Error('Invalid file format: Not an array.');
                        }
                        this.medications = importedMedications;
                        this.saveAndRender();
                        this.showToast(`Data imported successfully. ${this.medications.length} medication(s) loaded.`);
                    } catch (error) {
                        console.error('Error importing data:', error);
                        this.showToast(`Error importing data: ${error.message}`);
                    } finally {
                        event.target.value = null; 
                    }
                };
                reader.onerror = () => {
                    this.showToast('Error reading file.');
                    event.target.value = null;
                };
                reader.readAsText(file);
            }


            consumeMedication(id) {
                const medication = this.medications.find(m => m.id === id);
                if (!medication) return;
                medication.records.push(Date.now());
                this.saveAndRender();
                this.showToast(`${medication.name} logged.`);
            }

            showRecords(id, isFromPopState = false) {
                if (this.isScreenTransitioning && !isFromPopState) return; 
                const medication = this.medications.find(m => m.id === id);
                
                if (!medication) {
                    this.hideRecords(); 
                    return;
                }

                if (!isFromPopState && (!history.state || history.state.screen !== 'records' || history.state.medId !== id) ) {
                    history.pushState({ screen: 'records', medId: id }, `Records - ${medication.name}`, `#records/${id}`);
                }
                this.currentHistoryState = 'records';


                this.isScreenTransitioning = true;
                this.currentRecordsMedication = medication;
                
                this.dom.recordsTitle.textContent = medication.name;
                
                this.dom.mainScreen.style.transform = '';
                this.dom.recordsScreen.style.transform = '';

                this.dom.recordsScreen.classList.add('active'); 
                this.updateRecordsDisplay(); // Call AFTER .active class is added
                this.dom.mainScreen.classList.add('viewing-records');

                const onTransitionEnd = () => {
                    this.dom.recordsScreen.removeEventListener('transitionend', onTransitionEnd);
                    this.isScreenTransitioning = false;
                };
                this.dom.recordsScreen.addEventListener('transitionend', onTransitionEnd, { once: true });
            }

            hideRecords(isFromPopState = false) {
                if (this.isScreenTransitioning && this.currentRecordsMedication && !isFromPopState) return; 
                if (!this.recordsScreenActive() && !isFromPopState) return; 
                
                this.isScreenTransitioning = true;
                
                if (!isFromPopState && history.state?.screen === 'records') {
                     // This case is for UI elements like the back arrow triggering a history change
                     // history.back() is called by the event listener directly.
                     // This function will then be called again via popstate with isFromPopState = true.
                     // So, if !isFromPopState, we don't immediately animate out if a history action is pending.
                     // However, if called due to deletion, or if state is already 'main', we proceed.
                }
                 
                if (isFromPopState || !history.state || history.state.screen !== 'records') {
                    this.dom.mainScreen.style.transform = '';
                    this.dom.recordsScreen.style.transform = '';
                    this.dom.recordsScreen.classList.remove('active');
                    this.dom.mainScreen.classList.remove('viewing-records');
                }
                this.currentHistoryState = 'main';


                const onTransitionEnd = () => {
                    this.dom.recordsScreen.removeEventListener('transitionend', onTransitionEnd);
                    this.currentRecordsMedication = null;
                    this.activeMedicationForRecordEntry = null; 
                    this.isScreenTransitioning = false;
                    this.renderMedications(); 
                };
                
                const recordsScreenIsActuallyVisible = this.dom.recordsScreen.classList.contains('active') || getComputedStyle(this.dom.recordsScreen).transform !== 'none';

                if (recordsScreenIsActuallyVisible || isFromPopState) {
                     this.dom.recordsScreen.addEventListener('transitionend', onTransitionEnd, { once: true });
                } else { 
                    this.currentRecordsMedication = null;
                    this.activeMedicationForRecordEntry = null;
                    this.isScreenTransitioning = false;
                    this.renderMedications();
                }
            }

            updateRecordsDisplay() {
                if (!this.currentRecordsMedication) {
                    this.dom.recordsContent.innerHTML = '<div class="empty-records">No medication selected.</div>';
                    return;
                }
                const records = this.currentRecordsMedication.records;
                if (!records || records.length === 0) { 
                    this.dom.recordsContent.innerHTML = '<div class="empty-records">No records yet.</div>';
                } else {
                    const sortedRecords = [...records].sort((a, b) => a - b); 
                    this.dom.recordsContent.innerHTML = sortedRecords.map(timestamp => 
                        `<div class="record-item" data-timestamp="${timestamp}">
                            <span>${this.formatDateTime(timestamp)}</span>
                            <button class="record-entry-action-btn" data-timestamp="${timestamp}" aria-label="Edit or Delete Record Entry">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="currentColor"/></svg>
                            </button>
                        </div>`
                    ).join('');
                    
                    this.dom.recordsContent.querySelectorAll('.record-entry-action-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            const ts = parseInt(btn.dataset.timestamp);
                            this.prepareRecordEntryModal(ts);
                        });
                    });
                    if (this.recordsScreenActive()) {
                        setTimeout(() => { // Ensure DOM has updated
                            this.dom.recordsContent.scrollTop = this.dom.recordsContent.scrollHeight;
                        }, 0);
                    }
                }
            }


            getTimeSinceLastDose(med) { 
                if (!med.records || med.records.length === 0) return Infinity;
                return Date.now() - Math.max(...med.records); 
            }
            getTimeUntilNextDose(med) { const ts = this.getTimeSinceLastDose(med); return Math.max(0, med.timeBetweenHours * 3600000 - ts); }
            isSafeToConsume(med) { return this.getTimeUntilNextDose(med) === 0; }
            getProgressRatio(med) { const ts = this.getTimeSinceLastDose(med); return ts === Infinity ? 0 : Math.min(1, ts / (med.timeBetweenHours * 3600000)); }

            getCardColor(medication) {
                if (this.isSafeToConsume(medication)) {
                    return `linear-gradient(135deg, var(--safe-gradient-start) 0%, var(--safe-gradient-end) 100%)`;
                }
                const progress = this.getProgressRatio(medication);
                const rO = 230, gO = 81, bO = 0;   // Orange
                const rG = 46, gG = 125, bG = 50;  // Green
                const r = Math.round(rO + (rG - rO) * progress);
                const g = Math.round(gO + (gG - gO) * progress);
                const b = Math.round(bO + (bG - bO) * progress);
                return `rgb(${r}, ${g}, ${b})`; 
            }

            formatDuration(ms) {
                if (ms === Infinity) return 'N/A';
                const s = Math.floor(ms / 1000);
                const h = Math.floor(s / 3600);
                const m = Math.floor((s % 3600) / 60);
                if (h > 0) return `${h}h ${m}m`;
                if (m > 0) return `${m}m ${s % 60}s`;
                return `${s % 60}s`;
            }

            formatDateTime(ts) { 
                const date = new Date(ts);
                return date.toLocaleDateString(undefined, { 
                    weekday: 'short', month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
            }

            setupItemSwipeGestures(element, medication) { 
                if (element.hasClickActionAttached) return; 
                element.hasClickActionAttached = true;
            
                element.addEventListener('click', (e) => {
                    if (window.getSelection().toString()) { 
                        return;
                    }
                    e.stopPropagation(); 
                    this.showActionChoiceModal(medication);
                });
            }


            renderMedications() {
                if (this.isScreenTransitioning) return; 
                const container = this.dom.medicationsList;
                if (this.medications.length === 0) {
                    container.innerHTML = `<div class="empty-records"><p>No medications added yet.</p><p style="font-size: 14px; margin-top: 8px;">Tap an action below to start.</p></div>`;
                    return;
                }
                container.innerHTML = this.medications.map(med => {
                    const statusText = this.isSafeToConsume(med) ? 'Safe to take now' : `Next dose in: ${this.formatDuration(this.getTimeUntilNextDose(med))}`;
                    let lastConsumedText = 'Last: Never';
                    if (med.records && med.records.length > 0) {
                        const lastRecordTimestamp = Math.max(...med.records);
                        lastConsumedText = `Last: ${this.formatDateTime(lastRecordTimestamp)}`;
                    }
                    return `
                        <div class="medication-item" data-id="${med.id}" style="background: ${this.getCardColor(med)};">
                            <div class="medication-content-wrapper">
                                <div class="medication-content">
                                    <div class="medication-name">${med.name}</div>
                                    <div class="medication-status">${statusText}</div>
                                    <div class="medication-last-consumed">${lastConsumedText}</div>
                                </div>
                            </div>
                        </div>`;
                }).join('');
                container.querySelectorAll('.medication-item').forEach(item => {
                    const med = this.medications.find(m => m.id === item.dataset.id);
                    if (med) this.setupItemSwipeGestures(item, med); 
                });
            }
            
            saveAndRender() {
                this.saveMedications();
                this.renderMedications();
                if (this.currentRecordsMedication && this.dom.recordsScreen.classList.contains('active')) {
                    const updatedCurrentMed = this.medications.find(m => m.id === this.currentRecordsMedication.id);
                    if (updatedCurrentMed) {
                        this.currentRecordsMedication = updatedCurrentMed;
                        this.dom.recordsTitle.textContent = this.currentRecordsMedication.name; 
                    } else { 
                        this.hideRecords(); 
                        return;
                    }
                    this.updateRecordsDisplay();
                }
            }

            showAddModal() { this.prepareAddModal(); }
            hideAddModal() { this.hideMedicationModal(); }


            showToast(message) {
                if (this.toastTimeout) clearTimeout(this.toastTimeout);
                this.dom.toast.textContent = message;
                this.dom.toast.classList.add('active');
                this.toastTimeout = setTimeout(() => this.dom.toast.classList.remove('active'), 2800);
            }
            saveMedications() { localStorage.setItem('medications', JSON.stringify(this.medications)); }
        }

        const tracker = new MedicationTracker();

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) event.preventDefault();
            lastTouchEnd = now;
        }, { passive: false });

        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (e) => {
                    console.log('Service Worker: Install event');
                    e.waitUntil(self.skipWaiting());
                });
                self.addEventListener('activate', (e) => {
                    console.log('Service Worker: Activate event');
                    e.waitUntil(self.clients.claim());
                });
                self.addEventListener('fetch', (e) => {
                    // console.log('Service Worker: Fetching', e.request.url);
                    e.respondWith(
                        fetch(e.request).catch((error) => {
                            console.warn('Service Worker: Fetch failed for', e.request.url, error);
                        })
                    );
                }); 
            `;
            const swDataUrl = 'data:application/javascript;base64,' + btoa(unescape(encodeURIComponent(swCode)));

            navigator.serviceWorker.register(swDataUrl)
                .then(registration => {
                    console.log('Service Worker registered successfully with scope:', registration.scope);
                })
                .catch(error => {
                    console.warn('Service Worker registration failed:', error);
                });
        }
    </script>
</body>
</html>
